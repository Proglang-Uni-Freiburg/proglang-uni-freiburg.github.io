<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>lecture-2024-05-14.md - Chair of Programming Languages</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="Website for the Chair of Programming Languages at the University of Freiburg">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../highlight.css">
        <link rel="stylesheet" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" checked="true" class="hidden sidebar-visible">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 750) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../../home.html">Home</a></li><li class="chapter-item "><a href="../../../../team.html">Team</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../team/thiemann.html">Prof. Dr. Peter Thiemann</a></li><li class="chapter-item "><a href="../../../../team/jost.html">Marlis Jost</a></li><li class="chapter-item "><a href="../../../../team/van-den-heuvel.html">Dr. Bas van den Heuvel</a></li><li class="chapter-item "><a href="../../../../team/saffrich.html">Hannes Saffrich</a></li><li class="chapter-item "><a href="../../../../team/weidner.html">Marius Weidner</a></li></ol></li><li class="chapter-item "><a href="../../../../teaching.html">Teaching</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../teaching/24ss.html">Sommer 2024</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../../teaching/24ss/compiler-construction.html">Compiler Construction</a></li><li class="chapter-item "><a href="../../../../teaching/24ss/concurrency.html">Concurrency</a></li><li class="chapter-item "><a href="../../../../teaching/24ss/ocaml.html">Real World OCaml</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../../../about.html">About</a></li><li class="chapter-item "><a href="../../../../teaching/24ss/compiler-construction/slides/lecture-2024-05-03.html">lecture-2024-05-03.md</a></li><li class="chapter-item "><a href="../../../../teaching/24ss/compiler-construction/slides/lecture-2024-05-07.html">lecture-2024-05-07.md</a></li><li class="chapter-item expanded "><a href="../../../../teaching/24ss/compiler-construction/slides/lecture-2024-05-14.html" class="active">lecture-2024-05-14.md</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Chair of Programming Languages</h1>

                    <a href="https://uni-freiburg.de" target="_blank"><img class="menu-icon" src="https://cca.informatik.uni-freiburg.de/img/logo-new.png"></img></a>

                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this website ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <hr />
<h2>instructor: Prof. Dr. Peter Thiemann
date: 2024-05-14
title: Chapter 5</h2>
<h1 id="conditionals"><a class="header" href="#conditionals">Conditionals</a></h1>
<p>Changes to  the transformation pipeline</p>
<h2 id="shrink"><a class="header" href="#shrink">Shrink</a></h2>
<ul>
<li>remove <code>and</code> and <code>or</code> in favor of conditional expression</li>
</ul>
<pre><code>if not cond: sethen else: seelse
---&gt;
if cond: seelse else: sethen
</code></pre>
<h2 id="transformation-to-monadic-form"><a class="header" href="#transformation-to-monadic-form">Transformation to monadic form</a></h2>
<p>output grammar <code>ast_ir_mon</code></p>
<pre><code class="language-python">type ExprAtom = EConst | EVar 
type Expr = ExprAtom | EOp1 | EOp2 | EInput | ECompare
type Stmt = SPrint | SAssign | SCond
type Program = IList[Stmt]
</code></pre>
<ul>
<li>expression conditional eliminated</li>
<li>arguments to <code>EOp1</code>, <code>EOp2</code>,  <code>ECompare</code>, and <code>SPrint</code> are atomic</li>
<li>expression arguments to <code>SAssign</code>, <code>SCond</code> are not atomic</li>
<li>condition of <code>if</code> should always be a comparison</li>
</ul>
<h2 id="explication-of-control-57"><a class="header" href="#explication-of-control-57">Explication of control (5.7)</a></h2>
<p>input  grammar <code>ast_ir_mon</code>
output grammar <code>ast_ir_mon_exp</code></p>
<pre><code class="language-python">type ExprAtom = EConst | EVar 
type Expr = ExprAtom | EOp1 | EOp2 | EInput | ECompare
type Stmt = SPrint | SAssign | SCond | SGoto
type Block = IList[Stmt]
type Program = dict[Label, Block]

class SCond:
    test: ECompare
    body: Label
    orelse: Label

class SGoto:
    target: Label
</code></pre>
<ul>
<li>statement lists in conditional replaced by jump labels (here: <code>Label</code>)</li>
<li>New goto statement</li>
</ul>
<p>Write two functions</p>
<pre><code class="language-python">def explicate(p: src.Program) -&gt; tuple[tgt.Program, Label, Label]:
def explicate_block(out: tgt.Program, Lentry: Label, Lexit: Label, p: src.Program):
</code></pre>
<ul>
<li><code>explicate</code> creates a program dictionary and entry and exit labels</li>
<li><code>explicate_block</code>
<ul>
<li>traverses a block for a conditional</li>
<li>introduces labels for the true branch, the false branch and the
continuation (the code following the conditional)</li>
<li>recursively invokes <code>explicate_block</code> to translate the true branch
and the false branch</li>
<li>emits the new <code>SCond</code> and inserts the proper <code>SGoto</code>s</li>
<li><code>SCond</code> finishes a block, so we have to start a new block using
the continuation label</li>
</ul>
</li>
</ul>
<p>Roughly:</p>
<pre><code>SCond( test, body, orelse )
... more code ...
--&gt;

SCond( test, Ltrue, Lfalse )

Ltrue:
   code for body
   SGoto Lcont
   
Lfalse:
   code for orelse
   SGoto LCont

Lcont:
   explicate ... more code ...
</code></pre>
<h2 id="instruction-selection-58"><a class="header" href="#instruction-selection-58">Instruction Selection (5.8)</a></h2>
<ul>
<li>raise from single block to dict of blocks</li>
<li>all conditional statements with comparison have the shape  like this
<code>if a1 == a2: goto ltrue; else goto lfalse</code>
with atoms <code>a1</code> and <code>a2</code> so we can generate a conditional branch instruction</li>
<li>for reifying the result of a comparison in, say, a boolean variable
check the instructions <code>slt</code> and <code>sltu</code></li>
</ul>
<h2 id="register-allocation-59"><a class="header" href="#register-allocation-59">Register Allocation (5.9)</a></h2>
<ul>
<li>need to update liveness analysis</li>
<li>works on <em>control flow graph</em></li>
</ul>
<h3 id="control-flow-graph-cfg"><a class="header" href="#control-flow-graph-cfg">Control Flow Graph (CFG)</a></h3>
<p>A directed graph with</p>
<ul>
<li>
<p>nodes = <em>basic blocks</em>, i.e., a sequence of instructions starting with a label
and ending with a (conditional) jump.</p>
</li>
<li>
<p>edges = from block ending with a jump to <code>L</code> to block starting with
label <code>L</code></p>
</li>
<li>
<p>Each block has either one or two outgoing edges.</p>
</li>
<li>
<p>Each block has one or more incoming edges.</p>
</li>
<li>
<p>One node is labeled <code>entry</code>, the label <code>exit</code> points to the
conclusion of the code.</p>
</li>
</ul>
<h3 id="liveness-analysis"><a class="header" href="#liveness-analysis">Liveness Analysis</a></h3>
<ul>
<li>
<p>currently, the CFG is a DAG</p>
</li>
<li>
<p>for each node labeled <code>L</code> in the CFG, we maintain sets of variables
<code>live_after(L)</code> and <code>live_before(L)</code></p>
</li>
<li>
<p>initially all sets are empty</p>
</li>
<li>
<p>process all nodes in reverse topological order, i.e., the nodes pointing
to <code>exit</code> first</p>
</li>
<li>
<p>liveness analysis for node <code>L</code>:</p>
<ul>
<li>set <code>live_after(L)</code> to <code>live_before(L1)</code> U … U <code>live_before(Ln)</code>
where <code>L1</code> … <code>Ln</code> are the immediate successors of <code>L</code> in the CFG</li>
<li>calculate <code>live_before(L)</code> by transforming <code>live_after(L)</code>
according to the gen/kill rules of liveness analysis</li>
</ul>
</li>
<li>
<p>may calculate the interference right away without storing
<code>live_after</code> for each individual instruction</p>
</li>
</ul>
<h2 id="optimize-blocks--remove-jumps"><a class="header" href="#optimize-blocks--remove-jumps">Optimize Blocks / Remove Jumps</a></h2>
<ul>
<li>the material of 5.12.1 is not obviously applicable to our approach</li>
<li>but the same effect can be achieved using the approach of 5.12.2 or
by partially evaluating conditionals earlier in the pipeline</li>
</ul>
<h1 id="while"><a class="header" href="#while">While</a></h1>
<h2 id="control-flow-graph-for-summation-from-0-5"><a class="header" href="#control-flow-graph-for-summation-from-0-5">control flow graph for summation from 0-5</a></h2>
<pre><code>mainstart
    |
   block5
/    ^     \
|    |      |
block7     block8
            |
		   exit
</code></pre>
<ul>
<li>it’s cyclic</li>
<li>no traversal in topological order possible</li>
<li>set up liveness information as before</li>
<li>compute <code>live_before</code> from <code>live_after</code> until no <code>live_before</code>
changes.</li>
<li>called <em>fixed point iteration</em></li>
</ul>
<p>For instance, suppose <code>sum</code> is live in <code>block8</code>.
-&gt; sum in <code>live_after(block5)</code>
-&gt; sum in <code>live_before(block5)</code>
-&gt; <code>live_after(block7) = live_before(block5)</code> which contains <code>sum</code>
-&gt; <code>sum</code> in <code>live_before(block7)</code></p>
<ul>
<li>it’s also correct to compute the interference graph during the fixed
point iteration</li>
</ul>
<p>Suppose <code>LA(ins)</code> is some life after set.
Consider instruction <code>ins</code> and <code>LB(ins)</code> the corresponding life before
set.</p>
<p>If <code>LA(ins)</code> gets bigger, then <code>LB(ins)</code> stays the same or gets
bigger.
Because <code>LB(ins) =  (LA(ins) \ W(ins)) U R(ins)</code>
where <code>W(ins)</code> and <code>R(ins)</code> are constant sets (because the instruction
<code>ins</code> is fixed).
So technically, this computes a <em>monotone function</em>.</p>

                    </main>

                </div>
            </div>


        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
