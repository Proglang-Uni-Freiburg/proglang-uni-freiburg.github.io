<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Bas van den Heuvel" />
  <meta name="date" content="2024-04-24" />
  <title>The programming language Go, part 2</title>
  <style type="text/css">
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" type="text/css" media="screen, projection, print"
    href="https://www.w3.org/Talks/Tools/Slidy2/styles/slidy.css" />
  <script src="https://www.w3.org/Talks/Tools/Slidy2/scripts/slidy.js"
    charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">The programming language Go, part 2</h1>
  <p class="author">
Bas van den Heuvel
  </p>
  <p class="date">2024-04-24</p>
</div>
<div id="go-brief-summary" class="slide section level1">
<h1>Go: Brief Summary</h1>
<ul>
<li>Threads
<ul>
<li>Main thread</li>
<li>Goroutines</li>
<li>Termination of main thread terminates goroutines</li>
</ul></li>
<li>Channels
<ul>
<li>Bufferless / Synchronous
<ul>
<li>Send and receive synchronize</li>
<li>Send or receive block when counterpart not available</li>
</ul></li>
<li>Buffered / Asynchronous
<ul>
<li>Send writes to buffer, blocks if full</li>
<li>Receive reads from buffer, blocks if empty</li>
</ul></li>
<li>Can be used to implement concurrency control, such as mutual
exclusion</li>
</ul></li>
</ul>
</div>
<div id="channels-of-channels" class="slide section level1">
<h1>Channels of Channels</h1>
<p>Channels are first-class citizens</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="kw">var</span> ch <span class="kw">chan</span> <span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span></code></pre></div>
<p>A channel that accepts channels of integers.</p>
<p>This facility enables complex concurrent programming patterns</p>
<h2 id="example">Example</h2>
<p>Multiple clients make requests to a worker on a “public” channel,
which acknowledges successful processing on a “private” channel.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="kw">type</span> Request <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    id  <span class="dt">int</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>    ack <span class="kw">chan</span> <span class="dt">int</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="kw">func</span> worker<span class="op">(</span>req <span class="kw">chan</span> Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>    <span class="kw">var</span> c Request</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>        c <span class="op">=</span> <span class="op">&lt;-</span>req</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;request received from %d </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> c<span class="op">.</span>id<span class="op">)</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;notify&quot;</span><span class="op">)</span></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>        c<span class="op">.</span>ack <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="kw">func</span> client<span class="op">(</span>id <span class="dt">int</span><span class="op">,</span> req <span class="kw">chan</span> Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>    <span class="kw">var</span> ack <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>        c <span class="op">:=</span> Request<span class="op">{</span>id<span class="op">,</span> ack<span class="op">}</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>        req <span class="op">&lt;-</span> c</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>        <span class="op">&lt;-</span>ack</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>    <span class="kw">var</span> req <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> Request<span class="op">)</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>    <span class="cf">go</span> worker<span class="op">(</span>req<span class="op">)</span></span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>    <span class="cf">go</span> client<span class="op">(</span><span class="dv">1</span><span class="op">,</span> req<span class="op">)</span></span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>    client<span class="op">(</span><span class="dv">2</span><span class="op">,</span> req<span class="op">)</span></span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="sleeping-barber">Sleeping barber</h2>
<p>A more concrete example based on the clients/worker example.</p>
<ul>
<li>There is one barber and multiple clients.</li>
<li>Every client wants to get a haircut, if the barber is
available.</li>
<li>A client has to wait while another client is already getting their
haircut.</li>
</ul>
<p>A possible implementation in Go:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="kw">const</span> <span class="op">(</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>    NUMBER_OF_CHAIRS <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="kw">type</span> Request <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>    id  <span class="dt">int</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>    ack <span class="kw">chan</span> <span class="dt">int</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="co">// The worker</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="kw">func</span> barber<span class="op">(</span>queue <span class="op">(</span><span class="kw">chan</span> Request<span class="op">))</span> <span class="op">{</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>        req <span class="op">:=</span> <span class="op">&lt;-</span>queue</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;BARBER: Serving customer %d </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> req<span class="op">.</span>id<span class="op">)</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;BARBER: Done with customer %d </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> req<span class="op">.</span>id<span class="op">)</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>        req<span class="op">.</span>ack <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co">// The clients</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="kw">func</span> customer<span class="op">(</span>queue <span class="op">(</span><span class="kw">chan</span> Request<span class="op">),</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>    <span class="kw">var</span> ack <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;CUSTOMER: %d wants haircut </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>        req <span class="op">:=</span> Request<span class="op">{</span>id<span class="op">,</span> ack<span class="op">}</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>        queue <span class="op">&lt;-</span> req</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;CUSTOMER: %d sits on chair </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>        <span class="op">&lt;-</span>ack</span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;CUSTOMER: %d served by barber </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>    queue <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> Request<span class="op">,</span> NUMBER_OF_CHAIRS<span class="op">)</span></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>    <span class="cf">go</span> customer<span class="op">(</span>queue<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>    <span class="cf">go</span> customer<span class="op">(</span>queue<span class="op">,</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>    barber<span class="op">(</span>queue<span class="op">)</span></span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note:</p>
<ul>
<li>We use a channel with buffer to model waiting on a chair.</li>
<li>If a chair a still available (space in the buffer), then the client
can do something useful (reading a newspaper etc.) until it is their
turn.</li>
<li>Otherwise, the client is blocked from sending requests (which will
mean that the barbershop is full and the client will have to wait
outside).</li>
<li>In the model above, the haircut is “implicit”.</li>
</ul>
</div>
<div id="non-deterministic-choice-select" class="slide section level1">
<h1>Non-deterministic Choice (“select”)</h1>
<ul>
<li>It is often necessary to wait for multiple events.
<ul>
<li>For example, a request to Google Maps and OpenStreetMap.</li>
<li>One reply/message is sufficient.</li>
<li>Waiting for both replies/messages is not necessary.</li>
</ul></li>
<li>Example
<ul>
<li>Wait for message on <code>ch1</code></li>
<li>Wait for message on <code>ch2</code></li>
<li>Send message on <code>ch3</code></li>
</ul></li>
<li>Which order?</li>
</ul>
<p>First try:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>x <span class="op">=</span> <span class="op">&lt;-</span>ch1</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>y <span class="op">=</span> <span class="op">&lt;-</span>ch2</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>ch3 <span class="op">&lt;-</span> <span class="dv">1</span></span></code></pre></div>
<p>What if there is no sender on <code>ch1</code> but there is one on
<code>ch2</code>? The program above gets stuck.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>y <span class="op">=</span> <span class="op">&lt;-</span>ch2</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>x <span class="op">=</span> <span class="op">&lt;-</span>ch1</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>ch3 <span class="op">&lt;-</span> <span class="dv">1</span></span></code></pre></div>
<p>Gets stuck again, if there is no sender on <code>ch2</code> but there
is one on <code>ch1</code>.</p>
<ul>
<li>All three events above can block
<ul>
<li>Event = Sending/receiving on a channel</li>
</ul></li>
<li>But we want to continue, as soon as one of the events occurs!</li>
<li>The <code>select</code> primitive allows simultaneous waiting for
multiple events</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="cf">select</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="cf">case</span> x <span class="op">=</span> <span class="op">&lt;-</span>ch1<span class="op">:</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="cf">case</span> y <span class="op">=</span> <span class="op">&lt;-</span>ch2<span class="op">:</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="cf">case</span> ch3 <span class="op">&lt;-</span> <span class="dv">1</span><span class="op">:</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">// default and timeout possible</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>select</code> works as follows:</p>
<ol style="list-style-type: decimal">
<li><p><code>select</code> blocks if all events (cases) block.</p></li>
<li><p>If one event (case) occurs, the corresponding case is
chosen.</p></li>
<li><p>If multiple events (cases) occur, one corresponding case is
chosen randomly.</p></li>
<li><p>The remaining cases are no longer available!</p></li>
</ol>
<p>The example demonstrates that <code>select</code> supports <em>mixed
communication</em> in that it can manage several <em>send</em> and
<em>receive</em> events!</p>
<h2 id="example-random-choice">Example: “Random” Choice</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="kw">func</span> sel<span class="op">(</span>ch1<span class="op">,</span> ch2<span class="op">,</span> ch3 <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>    <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    <span class="cf">case</span> x <span class="op">:=</span> <span class="op">&lt;-</span>ch1<span class="op">:</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st"> ?ch1 = %d&quot;</span><span class="op">,</span> x<span class="op">)</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>    <span class="cf">case</span> y <span class="op">:=</span> <span class="op">&lt;-</span>ch2<span class="op">:</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st"> ?ch2 = %d&quot;</span><span class="op">,</span> y<span class="op">)</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>    <span class="cf">case</span> ch3 <span class="op">&lt;-</span> <span class="dv">1</span><span class="op">:</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st"> !ch3&quot;</span><span class="op">)</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="co">// Case selection is &quot;random&quot;.</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="kw">func</span> test1<span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>    ch1 <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>    ch2 <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>    ch3 <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>        ch1 <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>        ch2 <span class="op">&lt;-</span> <span class="dv">2</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a>        <span class="op">&lt;-</span>ch3</span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>    sel<span class="op">(</span>ch1<span class="op">,</span> ch2<span class="op">,</span> ch3<span class="op">)</span></span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a><span class="co">// Events that were not chosen remain available.</span></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a><span class="kw">func</span> test2<span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a>    ch1 <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a>    ch2 <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a>    ch3 <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a>        ch1 <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a>        ch2 <span class="op">&lt;-</span> <span class="dv">2</span></span>
<span id="cb7-49"><a href="#cb7-49" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb7-50"><a href="#cb7-50" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-52"><a href="#cb7-52" tabindex="-1"></a>        <span class="op">&lt;-</span>ch3</span>
<span id="cb7-53"><a href="#cb7-53" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb7-54"><a href="#cb7-54" tabindex="-1"></a></span>
<span id="cb7-55"><a href="#cb7-55" tabindex="-1"></a>    sel<span class="op">(</span>ch1<span class="op">,</span> ch2<span class="op">,</span> ch3<span class="op">)</span></span>
<span id="cb7-56"><a href="#cb7-56" tabindex="-1"></a>    sel<span class="op">(</span>ch1<span class="op">,</span> ch2<span class="op">,</span> ch3<span class="op">)</span></span>
<span id="cb7-57"><a href="#cb7-57" tabindex="-1"></a>    </span>
<span id="cb7-58"><a href="#cb7-58" tabindex="-1"></a>    fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb7-59"><a href="#cb7-59" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-60"><a href="#cb7-60" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-62"><a href="#cb7-62" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb7-63"><a href="#cb7-63" tabindex="-1"></a>        test1<span class="op">()</span></span>
<span id="cb7-64"><a href="#cb7-64" tabindex="-1"></a>        <span class="co">// test2()</span></span>
<span id="cb7-65"><a href="#cb7-65" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-66"><a href="#cb7-66" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="example-selection-is-fair">Example: Selection is “Fair”</h2>
<p>Consider:</p>
<ol style="list-style-type: decimal">
<li>The order of cases does not matter.</li>
<li>The choice is random and almost equally distributed.</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="kw">func</span> sel<span class="op">(</span>x time<span class="op">.</span>Duration<span class="op">,</span> a<span class="op">,</span> b <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    as <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    bs <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>        <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>a<span class="op">:</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>            as <span class="op">++</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>            fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;A(%d/%d)&quot;</span><span class="op">,</span>as<span class="op">,</span>bs<span class="op">)</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>b<span class="op">:</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>            bs <span class="op">++</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>            fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;B(%d/%d)&quot;</span><span class="op">,</span>as<span class="op">,</span>bs<span class="op">)</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span>x<span class="op">)</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="kw">func</span> snd<span class="op">(</span>c <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>        c <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>    a <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>    b <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>    <span class="cf">go</span> snd<span class="op">(</span>a<span class="op">)</span></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a>    <span class="cf">go</span> snd<span class="op">(</span>b<span class="op">)</span></span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a>    sel<span class="op">(</span><span class="fl">1e6</span><span class="op">,</span> a<span class="op">,</span> b<span class="op">)</span></span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="example-selection-with-prioritization">Example: Selection with
prioritization</h2>
<p>How can we prioritize a case?</p>
<h2 id="example-attempt-at-emulating-select-in-newsreader">Example:
Attempt at emulating <code>select</code> in Newsreader</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="kw">func</span> reuters<span class="op">(</span>ch <span class="kw">chan</span> <span class="dt">string</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>    ch <span class="op">&lt;-</span> <span class="st">&quot;REUTERS&quot;</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="kw">func</span> bloomberg<span class="op">(</span>ch <span class="kw">chan</span> <span class="dt">string</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>    ch <span class="op">&lt;-</span> <span class="st">&quot;BLOOMBERG&quot;</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="kw">func</span> newsReaderWithThreads<span class="op">(</span>reutersCh <span class="kw">chan</span> <span class="dt">string</span><span class="op">,</span> bloombergCh <span class="kw">chan</span> <span class="dt">string</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>    ch <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">string</span><span class="op">)</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>        y <span class="op">:=</span> <span class="op">&lt;-</span>reutersCh</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>        ch <span class="op">&lt;-</span> y</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>        y <span class="op">:=</span> <span class="op">&lt;-</span>bloombergCh</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>        ch <span class="op">&lt;-</span> y</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>    x <span class="op">:=</span> <span class="op">&lt;-</span>ch</span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>    fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;got news from %s </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> x<span class="op">)</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a><span class="kw">func</span> newsReaderWithSelect<span class="op">(</span>reutersCh <span class="kw">chan</span> <span class="dt">string</span><span class="op">,</span> bloombergCh <span class="kw">chan</span> <span class="dt">string</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>    <span class="kw">var</span> x <span class="dt">string</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>    <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>    <span class="cf">case</span> x <span class="op">=</span> <span class="op">&lt;-</span>reutersCh<span class="op">:</span></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>    <span class="cf">case</span> x <span class="op">=</span> <span class="op">&lt;-</span>bloombergCh<span class="op">:</span></span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>    fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;got news from %s </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> x<span class="op">)</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a><span class="kw">func</span> test<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a>    reutersCh <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">string</span><span class="op">)</span></span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a>    bloombergCh <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">string</span><span class="op">)</span></span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a>    <span class="cf">go</span> reuters<span class="op">(</span>reutersCh<span class="op">)</span></span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a>    <span class="cf">go</span> bloomberg<span class="op">(</span>bloombergCh<span class="op">)</span></span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a>    newsReaderWithThreads<span class="op">(</span>reutersCh<span class="op">,</span> bloombergCh<span class="op">)</span></span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a>    newsReaderWithThreads<span class="op">(</span>reutersCh<span class="op">,</span> bloombergCh<span class="op">)</span></span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li><p>We try to emulate a <code>select</code> with helper
threads.</p></li>
<li><p>The idea is that there are always two threads waiting for a
message from Reuters or Bloomberg. This message is then forwarded to the
Newsreader. See <code>newsReaderWithThreads</code>.</p></li>
<li><p>Yet, there is a problem if there are multiple Newsreaders.</p>
<ul>
<li><p>The Newsreader expects only one message (either from Reuters or
from Bloomberg).</p></li>
<li><p>Both messages are fetched from the respective message
channel.</p></li>
<li><p>As only one message is processed, the other message remains
unused and is “discarded”</p></li>
<li><p>Hence, further calls to <code>newsReaderWithThreads</code> lead
to deadlock.</p></li>
</ul></li>
<li><p>The situation is different for <code>newsReaderWithSelect</code>.
Thanks to <code>select</code>, only one of the messages is fetched from
the Reuters or Bloomberg channels.</p></li>
<li><p>E.g., if the first call to <code>newsReaderWithSelect</code>
fetches the Reuters message, then the second call can only fetch the
Bloomberg message.</p></li>
</ul>
<h2 id="select-with-timeouts-and-default">Select with timeouts and
default</h2>
<ul>
<li><p><code>select</code> picks one case randomly</p></li>
<li><p>If none of the cases occurs, <code>select</code> blocks</p></li>
<li><p>Using a timeout, the <code>select</code> can be unblocked (see
above for an example)</p></li>
<li><p>It is also possible to prevent blocking using
<code>default</code>.</p></li>
<li><p>Consider the following example:</p></li>
</ul>
<div class="sourceCode" id="cb10"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="cf">select</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="cf">case</span> <span class="op">&lt;-</span>ch1<span class="op">:</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="cf">case</span> ch2<span class="op">&lt;-</span><span class="dv">1</span><span class="op">:</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="cf">default</span><span class="op">:</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ul>
<li><p>If none of the first two cases occurs, then the third (default)
case is selected.</p></li>
<li><p>Using default, events can be prioritized. See the sleeping barber
exercise.</p></li>
</ul>
<h2 id="example-execution-of-multiple-tasks">Example: Execution of
multiple tasks</h2>
<ul>
<li>Multiple tasks will be executed simultaneously.</li>
<li>The program will continue as soon as all tasks are done.</li>
<li>This programming pattern is knows as <em>barrier</em>.</li>
</ul>
<div class="sourceCode" id="cb11"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="kw">func</span> task1<span class="op">()</span> <span class="op">{</span> time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="kw">func</span> task2<span class="op">()</span> <span class="op">{</span> time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">2</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="kw">func</span> task3<span class="op">()</span> <span class="op">{</span> time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">3</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="kw">func</span> barrier<span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    <span class="kw">var</span> ch <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    <span class="co">// run all three tasks concurrently</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>        task1<span class="op">()</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>        ch <span class="op">&lt;-</span> <span class="dv">1</span> <span class="co">// signal done</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>        task2<span class="op">()</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>        ch <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>        task3<span class="op">()</span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>        ch <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>    <span class="co">// collect results concurrently</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>    timeout <span class="op">:=</span> time<span class="op">.</span>After<span class="op">(</span><span class="dv">4</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>    <span class="cf">for</span> i <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>        <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>ch<span class="op">:</span></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>timeout<span class="op">:</span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>            fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;timed out&quot;</span><span class="op">)</span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>    fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;done&quot;</span><span class="op">)</span></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>    barrier<span class="op">()</span></span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We effectively model a <a
href="https://en.wikipedia.org/wiki/Semaphore_(programming)">counting
semaphore</a></p>
<!-- 
## Extending "barrier" (execution of multiple tasks)

The solution above ensures that *all* tasks are completed within a given amount of time.
We consider the following example, where *one* task must be completed with the time.
For example, all tasks should be processed within 500ms, where each task takes at most 100ms.

### First Try

Here is a first try.
We only give a code snippet.

~~~~~~~{.go}
    var ch = make(chan int)
    // run all three tasks concurrently
    go func() {
        task1()
        ch <- 1 // signal done
    }()
    go func() {
        task2()
        ch <- 1
    }()
    go func() {
        task3()
        ch <- 1
    }()

    timeout := time.After(500 * time.Millisecond)
    for i := 0; i < 3; i++ {
        timeoutEach := time.After(100 * time.Millisecond)
        select {
        case <-ch:
        case <-timeout:
            fmt.Println("timed out (global)")
            return
        case <-timeoutEach:
            fmt.Println("timed out (local)")
            return
        }

    }
    fmt.Println("done")
~~~~~~~~~~~~~~~

We set a global as well as a local timeout.
The local timeout is started again for each round, and waits for a single task.

Does this solution work?

No!
The local timeout is restarted, but the individual tasks are already started.
Hence, we cannot guarantee that each individual task takes at most 100ms.

### Correction


We need a timer for every task.
As such, we add the following helper function.


~~~~~~~~{.go}
func completeWithin(task func(), ms time.Duration) chan bool {
    var ch = make(chan int)
    var res = make(chan bool)
    go func() {
        task()
        ch <- 1
    }()
    t := time.After(ms * time.Millisecond)
    go func() {
        select {
        case <-ch:
            res <- true
        case <-t:
            res <- false
        }
    }()
    return res
}
~~~~~~~~~~~~~~~

The `completeWithin` function returns a channel which we can use to test whether the task is executed within the time.

~~~~~~~~~{.go}
    // 1. run all three tasks concurrently
    // must complete within 500ms
    r1 := completeWithin(task1, 500)
    r2 := completeWithin(task2, 500)
    r3 := completeWithin(task3, 500)

    // 2. query tasks
    b1 := <-r1
    b2 := <-r2
    b3 := <-r3

    // 3. check for any timeout
    if b1 && b2 && b3 {
        fmt.Println("done")
    } else {
        fmt.Println("timed out")
    }
~~~~~~~~~~~~~~~

Note that `completeWithin` is non-blocking:

1. All three tasks and their timeouts are started.

2. With the channels, the respective statuses are requested.

3. Check for timeout.


## Implementation of `select`


### Go Runtime System (rough overview)
  
1. All 'cases' are stored in an array.

2. The Go runtime system periodically checks whether one of the 'cases' is available (i.e., a synchronization is possible).

    * First, the array elements are (randomly) permuted.

    * Then one element is tested (for synchronizability).
    If no synchronization is possible, the Go runtime system continues with other threads.
    Otherwise, the first synchronizable 'case' is chosen.

### Alternative Implementation


The `select` command is powerful.
A naive implementation using helper threads and channels, leads to a different result (see the Newsreader example).
Interestingly, a complete implementation of `select` with only threads and channels is possible. -->
</div>
<div id="where-it-can-all-go-wrong" class="slide section level1">
<h1>Where it can all go wrong</h1>
<p>We consider failure scenarios in the context of concurrent
programming.</p>
<p>Challenge:</p>
<ul>
<li><p>Non-deterministic execution</p></li>
<li><p>Failure occurs, failure does not occur</p></li>
</ul>
<p>We consider:</p>
<ul>
<li><p>Deadlock</p></li>
<li><p>Starvation and livelock</p></li>
<li><p>Data race</p></li>
</ul>
<p>Methodic procedure:</p>
<ul>
<li><p>Observation of program behavior as trace</p></li>
<li><p>Trace = Sequence of events</p></li>
</ul>
</div>
<div id="deadlock" class="slide section level1">
<h1>Deadlock</h1>
<p>A deadlock occurs when all threads are blocked.</p>
<p>The Go runtime system recognizes such a situation and aborts.</p>
<p>Consider the following example:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="kw">func</span> snd<span class="op">(</span>ch <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="kw">var</span> x <span class="dt">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    x<span class="op">++</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>    ch <span class="op">&lt;-</span> x</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a><span class="kw">func</span> rcv<span class="op">(</span>ch <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>    <span class="kw">var</span> x <span class="dt">int</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>    x <span class="op">=</span> <span class="op">&lt;-</span>ch</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>    fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;received %d </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> x<span class="op">)</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>    <span class="kw">var</span> ch <span class="kw">chan</span> <span class="dt">int</span> <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>    <span class="cf">go</span> rcv<span class="op">(</span>ch<span class="op">)</span>   <span class="co">// R</span></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>    <span class="cf">go</span> snd<span class="op">(</span>ch<span class="op">)</span>   <span class="co">// S</span></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>    rcv<span class="op">(</span>ch<span class="op">)</span>      <span class="co">// Main</span></span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We study the possible behavior of the program above. To this end, we
use R, S and Main to point to the corresponding threads.</p>
<p>Program execution consists of events such as sending and receiving on
a channel. For events, we use the following notation:</p>
<pre><code>ch?    receiving on channel ch

ch!    sending on channel ch</code></pre>
<p>Note:</p>
<p>Events are blocking. Receiving is generally blocking. Sending
blocking if the buffer is full or if we are using a channel without
buffer.</p>
<p>Hence, the question: what is the precise meaning of events? We have
the following two options:</p>
<ol style="list-style-type: decimal">
<li><p>Event <code>ch?</code> means that we <strong>want</strong> to
receive on channel <code>ch</code>.</p></li>
<li><p>Event <code>ch?</code> means that we <strong>have</strong>
received on channel <code>ch</code>.</p></li>
</ol>
<p>The same holds for event <code>ch!</code>.</p>
<p>Hence, we use the following notation:</p>
<pre><code>pre(ch?)     wanting to receive on channel ch
post(ch?)    having received on channel ch

pre(ch!)     wanting to send on channel ch
post(ch!)    having sent on channel ch</code></pre>
<p>Summarized:</p>
<ul>
<li><p><code>pre</code> describes the event before the corresponding
operation takes place.</p></li>
<li><p><code>post</code> describes the event after the corresponding
operation has taken place.</p></li>
</ul>
<p>We consider a possible program execution expressed as a
<em>trace</em>. A trace is a sequence of events and expresses the
interleaved execution of individual threads.</p>
<p>Is the trace-based description of program execution related to the
state-based execution? Yes, both notations/concepts have the goal to
describe (concurrent) program execution. The relationship between the
two is somewhat like regular expressions versus finite machines.</p>
<p>To represent traces, we use a tabular notation. We write
<code>ch?_1</code> to refer to the event <code>ch?</code> at trace
position 1.</p>
<pre><code>    R         S             Main

1.  pre(ch?)
2.                          pre(ch?)
3.            pre(ch!)
4.            post(ch!)
5.  post(ch?)</code></pre>
<p>In the run above, S communicates with R. This can be read from the
trace, because after <code>pre(ch!)</code> in S comes a
<code>post(ch!)</code>, and after <code>pre(ch?)</code> in R comes a
<code>post(ch?)</code>. In case of communication (send-receive), we
assume that in the trace the post event of the send always occurs before
the post event of the receive.</p>
<p>Threads S and R terminate. Thread Main blocks, because there is no
communication partner for <code>ch?_2</code>. All threads (here only
Main) are blocked. Hence, deadlock!</p>
<p>Consider the following alternative program execution:</p>
<pre><code>    R         S            Main

1.  pre(ch?)
2.                         pre(ch?)
3.            pre(ch!)
4.            post(ch!)
5.                         post(ch?)
</code></pre>
<p>In this run, S communicates with Main, and R is blocked. However,
since Main terminates, thread R is also terminated. Hence, we do not
observe a deadlock.</p>
</div>
<div id="starvation" class="slide section level1">
<h1>Starvation</h1>
<p>Consider the following variant of the example above. All channel
operations (send/receive) occur in endless loops, so the program does
not terminate.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="kw">func</span> snd<span class="op">(</span>ch <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>    <span class="kw">var</span> x <span class="dt">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>        x<span class="op">++</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>        ch <span class="op">&lt;-</span> x</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="kw">func</span> rcv<span class="op">(</span>ch <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>    <span class="kw">var</span> x <span class="dt">int</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>        x <span class="op">=</span> <span class="op">&lt;-</span>ch</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;received %d </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> x<span class="op">)</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a>    <span class="kw">var</span> ch <span class="kw">chan</span> <span class="dt">int</span> <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>    <span class="cf">go</span> rcv<span class="op">(</span>ch<span class="op">)</span>   <span class="co">// R</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a>    <span class="cf">go</span> snd<span class="op">(</span>ch<span class="op">)</span>   <span class="co">// S</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a>    rcv<span class="op">(</span>ch<span class="op">)</span>      <span class="co">// Main</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>A deadlock does not occur. However, it is possible that, for example,
Main starves (does not progress), because S and R always communicate
with each other. Such a situation is considered starvation.</p>
<p>Concrete trace:</p>
<pre><code>    R          S               Main

1.  pre(ch?)
2.                             pre(ch?)
3.             pre(ch!)
4.             post(ch!)
5.  post(ch?)
6.  pre(ch?)
7.             pre(ch!)
8.             post(ch!)
9.  post(ch?)
....</code></pre>
<p>We assume that S always communicates with R (and never with Main).
Hence, lines 6-9 keep on repeating. Extremely unlikely in practice but
theoretically possible.</p>
</div>
<div id="livelock" class="slide section level1">
<h1>Livelock</h1>
<p>A livelock describes a situation in which always at least one thread
is not blocked, but no thread progresses.</p>
<p>A livelock does not occur in the previous example. We will study
livelocks in context of the Dining Philosophers exercise.</p>
</div>
<div id="data-race" class="slide section level1">
<h1>Data race</h1>
<p>A data race describes a situation in which two unprotected,
conflicting memory operations (at least one write) occur
simultaneously.</p>
<p>Consider the following example:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>    <span class="kw">var</span> x <span class="dt">int</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>    y <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span> <span class="co">// T</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>        y <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>        x<span class="op">++</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>        <span class="op">&lt;-</span>y</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>    <span class="op">}()</span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>    x<span class="op">++</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>    y <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>    <span class="op">&lt;-</span>y</span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>    time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>    fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;done </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We write Main to denote the main thread, and T for the other thread.
Besides send/receive events, we also consider write/read events.</p>
<p>We write <code>w(x)</code> to denote a write event on variable
<code>x</code>, and <code>r(x)</code> for a read event.</p>
<p>We consider a possible program execution expressed as a trace. We
simplify the operation <code>x++</code> to <code>w(x)</code>.</p>
<p>We do not distinguish pre and post events; all events are post
events. Hence, we omit pre and post annotations.</p>
<pre><code>     Main        T

1.               y!
2.               w(x)
3.   w(x)</code></pre>
<p>In a program execution (represented as trace), a data race occurs
when two conflicting write/read events occur directly after one another.
See above.</p>
<p>Consider the following alternative trace:</p>
<pre><code>     Main        T

1.               y!
2.               w(x)
3.               y?
4.   w(x)</code></pre>
<p>In this trace, the data race is no longer visible, because between
<code>w(x)_2</code> and <code>w(x)_4</code> there is now
<code>y?_3</code>.</p>
<p>However, the trace can be reordered such that the data race does
occur. The following reordering is allowed:</p>
<pre><code>     Main        T

1.               y!
2.               w(x)
3.   w(x)
4.               y?</code></pre>
<p>We consider another trace:</p>
<pre><code>     Main        T

1.   w(x)
2.   y!
3.   y?
4.               y!
5.               w(x)
6.               y?</code></pre>
<p>In this trace, the data race does not occur.</p>
<!-- *Note.*
To detect the data race (between the two writes on `x`), it is necessary to reorder the critical sections.
A dynamic data race analysis based on the Lamport happens-before relationship is not able to reorder the critical sections at trace positions 2-3 and 4-6.
However, there are methods to allow such a reordering.
We will discuss dynamic data race analysis separately. -->
<p>The problem of reordering traces to detect data races (and more) is a
field of research on its own. We will discuss such “dynamic trace
analysis” separately.</p>
</div>
<div id="conclusion" class="slide section level1">
<h1>Conclusion</h1>
<ul>
<li>A deadlock (if one occurs) is observable by the entire system coming
to a halt.</li>
<li>Observing starvation and livelock is trickier.</li>
<li>For all failure scenarios holds: they can occur, but do not have to
occur.
<ul>
<li>For example, a deadlock may only manifest for one particular program
execution (under one particular configuration etc.).</li>
</ul></li>
<li>Data races are not directly observable from a trace, but require
reordering of the trace.</li>
<li>Hence, discovering concurrent program failures is tricky.</li>
</ul>
</div>
<div id="summary" class="slide section level1">
<h1>Summary</h1>
<ul>
<li><p>Overview of Go primitives for concurrent programming through
message-exchange</p>
<ul>
<li><p>Multi-threading</p></li>
<li><p>Typed channels</p></li>
<li><p>Synchronous (without buffer) and asynchronous (with buffer)
channels.</p></li>
<li><p>Non-deterministic choice</p></li>
</ul></li>
<li><p>Theoretical foundations: Communicating Sequential Processes by
Sir Tony Hoare</p></li>
<li><p>Related
languages<!--  (who do it better for the most part) -->:</p>
<ul>
<li>Concurrent ML</li>
<li>Haskell</li>
<li>Scala</li>
<li>Erlang</li>
</ul></li>
<li><p>Typical problems of concurrent programming</p>
<ul>
<li><p>Deadlock</p></li>
<li><p>Livelock</p></li>
<li><p>Starvation</p></li>
<li><p>Data race</p></li>
</ul></li>
</ul>
<!-- * Looking ahead

    * Program analysis to detect deadlock, ... -->
</div>
<div id="exercise-3-publishsubscribe" class="slide section level1">
<h1>Exercise 3: Publish/Subscribe</h1>
<p>Your task is to implement a publish/subscribe server with multiple
example clients.</p>
<ul>
<li>A server registers subscription requests from clients.</li>
<li>A publisher sends messages to the server.</li>
<li>The server forwards these messages to registered clients.</li>
<li>You can use the “channels of channels” example as a basis. Make the
following adjustments:
<ul>
<li>Instead of a Request channel, there are Publish and Subscribe
channels. The server receives on both channels and directs “Publish”
messages to the corresponding registered clients.</li>
<li>Note: if the server manages all clients in one thread, the server
can block when Subscribe clients stop reading messages. How can you fix
this problem?</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb24"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co">// publish, subscribe example, adopted from Russ Cox</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;strconv&quot;</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;container/list&quot;</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a><span class="co">In the following, we incrementally develop a solution.</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a><span class="co">Firstly, a few necessary data structures.</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a><span class="co">// Every message consists of a &quot;topic&quot; and a &quot;body&quot;.</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a><span class="kw">type</span> Message <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a>    topic <span class="dt">string</span></span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>    body  <span class="dt">string</span></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a><span class="co">// Every subscriber registers a &quot;topic&quot; and a &quot;news&quot; channel along which messages on the corresponding &quot;topic&quot; can be received.</span></span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a><span class="kw">type</span> Sub <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a>    topic <span class="dt">string</span></span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a>    news  <span class="kw">chan</span> Message</span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a><span class="co">// The server holds two channels: csub on which subscribers can register, and cpub along which a published sends messages. </span></span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a><span class="kw">type</span> Server <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a>    csub <span class="kw">chan</span> Sub</span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a>    cpub <span class="kw">chan</span> Message</span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a><span class="co">// Subscriber and Publisher</span></span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a></span>
<span id="cb24-35"><a href="#cb24-35" tabindex="-1"></a><span class="co">// A subscriber registers and waits for messages.</span></span>
<span id="cb24-36"><a href="#cb24-36" tabindex="-1"></a><span class="kw">func</span> subscriber<span class="op">(</span>server Server<span class="op">,</span> t <span class="dt">string</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-37"><a href="#cb24-37" tabindex="-1"></a>    s <span class="op">:=</span> Sub<span class="op">{</span>topic<span class="op">:</span> t<span class="op">,</span> news<span class="op">:</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> Message<span class="op">)}</span></span>
<span id="cb24-38"><a href="#cb24-38" tabindex="-1"></a>    server<span class="op">.</span>csub <span class="op">&lt;-</span> s</span>
<span id="cb24-39"><a href="#cb24-39" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb24-41"><a href="#cb24-41" tabindex="-1"></a>        msg <span class="op">:=</span> <span class="op">&lt;-</span>s<span class="op">.</span>news</span>
<span id="cb24-42"><a href="#cb24-42" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;topic %s: </span><span class="ch">\n</span><span class="st"> message %s </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> t<span class="op">,</span> msg<span class="op">.</span>body<span class="op">)</span></span>
<span id="cb24-43"><a href="#cb24-43" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-44"><a href="#cb24-44" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-45"><a href="#cb24-45" tabindex="-1"></a></span>
<span id="cb24-46"><a href="#cb24-46" tabindex="-1"></a><span class="co">// A publisher (here, &quot;slashdot&quot;) sends messages along the corresponding channel.</span></span>
<span id="cb24-47"><a href="#cb24-47" tabindex="-1"></a><span class="kw">func</span> slashdot<span class="op">(</span>server Server<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-48"><a href="#cb24-48" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb24-49"><a href="#cb24-49" tabindex="-1"></a>        m <span class="op">:=</span> Message<span class="op">{</span>topic<span class="op">:</span> <span class="st">&quot;slashdot&quot;</span><span class="op">,</span> body<span class="op">:</span> <span class="st">&quot;some news&quot;</span><span class="op">}</span></span>
<span id="cb24-50"><a href="#cb24-50" tabindex="-1"></a>        server<span class="op">.</span>cpub <span class="op">&lt;-</span> m</span>
<span id="cb24-51"><a href="#cb24-51" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">2</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb24-52"><a href="#cb24-52" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-53"><a href="#cb24-53" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-54"><a href="#cb24-54" tabindex="-1"></a></span>
<span id="cb24-55"><a href="#cb24-55" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb24-56"><a href="#cb24-56" tabindex="-1"></a><span class="co">The server manages the subscriber list.</span></span>
<span id="cb24-57"><a href="#cb24-57" tabindex="-1"></a><span class="co">At the same time (via `select`), it listens for subscribers and publishers.</span></span>
<span id="cb24-58"><a href="#cb24-58" tabindex="-1"></a><span class="co">A subscriber is simply added to the list.</span></span>
<span id="cb24-59"><a href="#cb24-59" tabindex="-1"></a><span class="co">A messages from a publisher is sent to the corresponding subscribers.</span></span>
<span id="cb24-60"><a href="#cb24-60" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb24-61"><a href="#cb24-61" tabindex="-1"></a><span class="kw">func</span> pubSubServer<span class="op">(</span>server Server<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-62"><a href="#cb24-62" tabindex="-1"></a>    subscribers <span class="op">:=</span> list<span class="op">.</span>New<span class="op">()</span></span>
<span id="cb24-63"><a href="#cb24-63" tabindex="-1"></a></span>
<span id="cb24-64"><a href="#cb24-64" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb24-65"><a href="#cb24-65" tabindex="-1"></a>        <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb24-66"><a href="#cb24-66" tabindex="-1"></a>        <span class="cf">case</span> s <span class="op">:=</span> <span class="op">&lt;-</span>server<span class="op">.</span>csub<span class="op">:</span></span>
<span id="cb24-67"><a href="#cb24-67" tabindex="-1"></a>            subscribers<span class="op">.</span>PushBack<span class="op">(</span>s<span class="op">)</span></span>
<span id="cb24-68"><a href="#cb24-68" tabindex="-1"></a>        <span class="cf">case</span> m <span class="op">:=</span> <span class="op">&lt;-</span>server<span class="op">.</span>cpub<span class="op">:</span></span>
<span id="cb24-69"><a href="#cb24-69" tabindex="-1"></a>            <span class="cf">for</span> e <span class="op">:=</span> subscribers<span class="op">.</span>Front<span class="op">();</span> e <span class="op">!=</span> <span class="ot">nil</span><span class="op">;</span> e <span class="op">=</span> e<span class="op">.</span>Next<span class="op">()</span> <span class="op">{</span></span>
<span id="cb24-70"><a href="#cb24-70" tabindex="-1"></a>                s <span class="op">:=</span> <span class="op">(</span>e<span class="op">.</span>Value<span class="op">).(</span>Sub<span class="op">)</span> <span class="co">// type assertion</span></span>
<span id="cb24-71"><a href="#cb24-71" tabindex="-1"></a>                <span class="cf">if</span> s<span class="op">.</span>topic <span class="op">==</span> m<span class="op">.</span>topic <span class="op">{</span></span>
<span id="cb24-72"><a href="#cb24-72" tabindex="-1"></a>                    s<span class="op">.</span>news <span class="op">&lt;-</span> m <span class="co">// (B)</span></span>
<span id="cb24-73"><a href="#cb24-73" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb24-74"><a href="#cb24-74" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb24-75"><a href="#cb24-75" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb24-76"><a href="#cb24-76" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-77"><a href="#cb24-77" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-78"><a href="#cb24-78" tabindex="-1"></a></span>
<span id="cb24-79"><a href="#cb24-79" tabindex="-1"></a><span class="co">/* Blocking of the server.</span></span>
<span id="cb24-80"><a href="#cb24-80" tabindex="-1"></a></span>
<span id="cb24-81"><a href="#cb24-81" tabindex="-1"></a><span class="co">Now, for the question in the exercise: if the server manages all clients in one thread, the server can block when Subscribe clients stop reading messages.</span></span>
<span id="cb24-82"><a href="#cb24-82" tabindex="-1"></a><span class="co">Why?</span></span>
<span id="cb24-83"><a href="#cb24-83" tabindex="-1"></a><span class="co">What could alleviate the problem?</span></span>
<span id="cb24-84"><a href="#cb24-84" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb24-85"><a href="#cb24-85" tabindex="-1"></a></span>
<span id="cb24-86"><a href="#cb24-86" tabindex="-1"></a><span class="kw">func</span> reuters<span class="op">(</span>server Server<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-87"><a href="#cb24-87" tabindex="-1"></a>    i <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb24-88"><a href="#cb24-88" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb24-89"><a href="#cb24-89" tabindex="-1"></a>        s <span class="op">:=</span> strconv<span class="op">.</span>Itoa<span class="op">(</span>i<span class="op">)</span></span>
<span id="cb24-90"><a href="#cb24-90" tabindex="-1"></a>        m <span class="op">:=</span> Message<span class="op">{</span>topic<span class="op">:</span> <span class="st">&quot;reuters&quot;</span><span class="op">,</span> body<span class="op">:</span> <span class="st">&quot;some news &quot;</span> <span class="op">+</span> s<span class="op">}</span></span>
<span id="cb24-91"><a href="#cb24-91" tabindex="-1"></a>        server<span class="op">.</span>cpub <span class="op">&lt;-</span> m</span>
<span id="cb24-92"><a href="#cb24-92" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb24-93"><a href="#cb24-93" tabindex="-1"></a>        i<span class="op">++</span></span>
<span id="cb24-94"><a href="#cb24-94" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-95"><a href="#cb24-95" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb24-96"><a href="#cb24-96" tabindex="-1"></a></span>
<span id="cb24-97"><a href="#cb24-97" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb24-98"><a href="#cb24-98" tabindex="-1"></a>    server <span class="op">:=</span> Server<span class="op">{</span>csub<span class="op">:</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> Sub<span class="op">),</span> cpub<span class="op">:</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> Message<span class="op">)}</span></span>
<span id="cb24-99"><a href="#cb24-99" tabindex="-1"></a></span>
<span id="cb24-100"><a href="#cb24-100" tabindex="-1"></a>    <span class="cf">go</span> pubSubServer<span class="op">(</span>server<span class="op">)</span></span>
<span id="cb24-101"><a href="#cb24-101" tabindex="-1"></a>    <span class="cf">go</span> subscriber<span class="op">(</span>server<span class="op">,</span> <span class="st">&quot;slashdot&quot;</span><span class="op">)</span></span>
<span id="cb24-102"><a href="#cb24-102" tabindex="-1"></a>    <span class="cf">go</span> subscriber<span class="op">(</span>server<span class="op">,</span> <span class="st">&quot;reuters&quot;</span><span class="op">)</span></span>
<span id="cb24-103"><a href="#cb24-103" tabindex="-1"></a></span>
<span id="cb24-104"><a href="#cb24-104" tabindex="-1"></a>    <span class="cf">go</span> slashdot<span class="op">(</span>server<span class="op">)</span></span>
<span id="cb24-105"><a href="#cb24-105" tabindex="-1"></a>    reuters<span class="op">(</span>server<span class="op">)</span></span>
<span id="cb24-106"><a href="#cb24-106" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="exercise-4-quantified-semaphor" class="slide section level1">
<h1>Exercise 4: Quantified Semaphor</h1>
<p>We consider an implementation of a buffered channel based solely on
channels without buffers.</p>
<p>To simplify, we consider a quantified semaphore. That is, we ignore
the actual messages. We expect the following signature:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="kw">type</span> QSem</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="kw">func</span> newQSem<span class="op">(</span>q <span class="dt">int</span><span class="op">)</span> QSem</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="kw">func</span> wait<span class="op">(</span>QSem<span class="op">)</span></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="kw">func</span> signal<span class="op">(</span>QSem<span class="op">)</span></span></code></pre></div>
<p>Note that you need to define <code>QSem</code> yourself. Your
implementation should only use ``simple’’ non-buffered channels
(otherwise, the exercise is trivial).</p>
<p>Initially, the quantity is set with <code>newQSem</code>. Function
<code>wait</code> lowers the quantity and blocks if the quantity is
zero. Function <code>signal</code> increases the quantity and blocks if
the quantity is equal to the initial quantity. A blocked
<code>wait</code> is unblocked by a <code>signal</code>.</p>
<p>We consider an example with four parallel threads. Two threads
execute <code>wait</code>, and the other two <code>signal</code>. We
assume that the quantity is at most 1, where initially the actual
quantity is 1 already.</p>
<h3 id="notation">Notation</h3>
<ul>
<li>R = Running</li>
<li>D = Done</li>
<li>B = Blocked</li>
<li>Ui = Unblock Thread i</li>
</ul>
<h3 id="example-execution">Example execution</h3>
<table>
<thead>
<tr class="header">
<th align="left">Quantity</th>
<th>Thread 1</th>
<th>Thread 2</th>
<th>Thread 3</th>
<th>Thread 4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td>wait</td>
<td>wait</td>
<td>signal</td>
<td>signal</td>
</tr>
<tr class="even">
<td align="left"></td>
<td>R</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td align="left">0</td>
<td>D</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td align="left"></td>
<td></td>
<td>R</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td></td>
<td>B</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td align="left"></td>
<td></td>
<td></td>
<td>R</td>
<td></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td></td>
<td></td>
<td>U2</td>
<td></td>
</tr>
<tr class="even">
<td align="left"></td>
<td></td>
<td></td>
<td>D</td>
<td></td>
</tr>
<tr class="odd">
<td align="left"></td>
<td></td>
<td>D</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td align="left"></td>
<td></td>
<td></td>
<td></td>
<td>R</td>
</tr>
<tr class="odd">
<td align="left">1</td>
<td></td>
<td></td>
<td></td>
<td>D</td>
</tr>
</tbody>
</table>
<h3 id="explanation">Explanation</h3>
<ul>
<li>Thread 1 runs, <code>wait</code> decreases the quantity.</li>
<li>Thread 2 runs and blocks, since the quantity cannot go below 0.</li>
<li>Thread 3 runs.
<ul>
<li>Since there is a blocked <code>wait</code> thread, this will be
signalled to continue.</li>
<li>As such, the state of thread 2 changes from blocked to waiting.</li>
<li>It is still thread 3’s turn; it terminates.</li>
</ul></li>
<li>Thread 2 takes another turn.
<ul>
<li>Note that the quantity is 0, since the <code>wait</code> in thread 2
and the <code>signal</code> in thread 3 occur simultaneously.</li>
</ul></li>
<li>Thread 4 takes its turn and increases the quantity by one.</li>
</ul>
<h3 id="hints-and-comments">Hints and comments</h3>
<p>Access to the actual quantity stored in <code>QSem</code> must be
protected. To guarantee a mutual exclusion for simultaneous
<code>wait</code> and <code>signal</code>, we shall use a mutex (as seen
in the previous lecture).</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="kw">type</span> Mutex <span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="kw">type</span> QSem <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>   q    <span class="dt">int</span>     <span class="co">// max quantity</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>   curr <span class="dt">int</span>     <span class="co">// current quantity</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>   m    Mutex   <span class="co">// guarantee mutually exclusive access</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="exercise-51-extending-the-sleeping-barber"
class="slide section level1">
<h1>Exercise 5(1): Extending the Sleeping Barber</h1>
<p>Extend the Sleeping Barber example:</p>
<ol style="list-style-type: decimal">
<li>More barbers.</li>
<li>A channel per barber.</li>
<li>Prioritization, e.g.,
<ul>
<li>Selection of an available barber.</li>
<li>Preference.</li>
</ul></li>
</ol>
<p>To repeat, the simple version.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="kw">const</span> <span class="op">(</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>    NUMBER_OF_CHAIRS <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a><span class="kw">type</span> Request <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a>    id  <span class="dt">int</span></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a>    ack <span class="kw">chan</span> <span class="dt">int</span></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a><span class="kw">func</span> barber<span class="op">(</span>waitQ <span class="op">(</span><span class="kw">chan</span> Request<span class="op">))</span> <span class="op">{</span></span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a>        req <span class="op">:=</span> <span class="op">&lt;-</span>waitQ</span>
<span id="cb27-18"><a href="#cb27-18" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;BARBER: Serving customer %d </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> req<span class="op">.</span>id<span class="op">)</span></span>
<span id="cb27-19"><a href="#cb27-19" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb27-20"><a href="#cb27-20" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;BARBER: Done with customer %d </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> req<span class="op">.</span>id<span class="op">)</span></span>
<span id="cb27-21"><a href="#cb27-21" tabindex="-1"></a>        req<span class="op">.</span>ack <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb27-22"><a href="#cb27-22" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-23"><a href="#cb27-23" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb27-24"><a href="#cb27-24" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" tabindex="-1"></a><span class="kw">func</span> customer<span class="op">(</span>waitQ <span class="op">(</span><span class="kw">chan</span> Request<span class="op">),</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb27-26"><a href="#cb27-26" tabindex="-1"></a>    <span class="kw">var</span> ack <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb27-27"><a href="#cb27-27" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb27-28"><a href="#cb27-28" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;CUSTOMER: %d wants hair cut </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb27-29"><a href="#cb27-29" tabindex="-1"></a>        req <span class="op">:=</span> Request<span class="op">{</span>id<span class="op">,</span> ack<span class="op">}</span></span>
<span id="cb27-30"><a href="#cb27-30" tabindex="-1"></a>        waitQ <span class="op">&lt;-</span> req</span>
<span id="cb27-31"><a href="#cb27-31" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;CUSTOMER: %d sits on chair </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb27-32"><a href="#cb27-32" tabindex="-1"></a>        <span class="op">&lt;-</span>ack</span>
<span id="cb27-33"><a href="#cb27-33" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;CUSTOMER: %d served by barber </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb27-34"><a href="#cb27-34" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb27-35"><a href="#cb27-35" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb27-36"><a href="#cb27-36" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb27-37"><a href="#cb27-37" tabindex="-1"></a></span>
<span id="cb27-38"><a href="#cb27-38" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb27-39"><a href="#cb27-39" tabindex="-1"></a>    <span class="kw">var</span> waitQ <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> Request<span class="op">,</span> NUMBER_OF_CHAIRS<span class="op">)</span></span>
<span id="cb27-40"><a href="#cb27-40" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" tabindex="-1"></a>    <span class="cf">go</span> customer<span class="op">(</span>waitQ<span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb27-42"><a href="#cb27-42" tabindex="-1"></a>    <span class="cf">go</span> customer<span class="op">(</span>waitQ<span class="op">,</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb27-43"><a href="#cb27-43" tabindex="-1"></a>    barber<span class="op">(</span>waitQ<span class="op">)</span></span>
<span id="cb27-44"><a href="#cb27-44" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="exercise-52-extending-the-sleeping-barber-ii"
class="slide section level1">
<h1>Exercise 5(2): Extending the Sleeping Barber II</h1>
<p>Another variant of the Sleeping Barber. We give a few example
solutions. Try to figure out how this implementation can fail.</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="co">// Sleeping barber variant with distinction among blond and red haired customers</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>    <span class="st">&quot;fmt&quot;</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>    <span class="st">&quot;math/rand&quot;</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>    <span class="st">&quot;time&quot;</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a><span class="co">// Barber shall wait for either a group of blonds or reds.</span></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a><span class="co">// The quantities for each group are defined by the following constants.</span></span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a><span class="kw">const</span> BLONDS <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a><span class="kw">const</span> REDS <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a><span class="co">// Sample solution.</span></span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a><span class="kw">func</span> barber<span class="op">(</span>blond <span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span> red <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a>    seenBlonds <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a>    seenReds <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a>        <span class="co">// Check if group has been formed.</span></span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a>        <span class="cf">if</span> seenReds <span class="op">==</span> REDS <span class="op">{</span></span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a>            fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st"> Cutting reds!&quot;</span><span class="op">)</span></span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a>            seenReds <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a>        <span class="cf">if</span> seenBlonds <span class="op">==</span> BLONDS <span class="op">{</span></span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a>            fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;</span><span class="ch">\n</span><span class="st"> Cutting blonds!&quot;</span><span class="op">)</span></span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a>            seenBlonds <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a>        <span class="co">// Check for blonds and reds wanting to join group.</span></span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a>        <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>blond<span class="op">:</span></span>
<span id="cb28-35"><a href="#cb28-35" tabindex="-1"></a>            seenBlonds<span class="op">++</span></span>
<span id="cb28-36"><a href="#cb28-36" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>red<span class="op">:</span></span>
<span id="cb28-37"><a href="#cb28-37" tabindex="-1"></a>            seenReds<span class="op">++</span></span>
<span id="cb28-38"><a href="#cb28-38" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb28-39"><a href="#cb28-39" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-40"><a href="#cb28-40" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb28-41"><a href="#cb28-41" tabindex="-1"></a></span>
<span id="cb28-42"><a href="#cb28-42" tabindex="-1"></a><span class="co">// Another attempt.</span></span>
<span id="cb28-43"><a href="#cb28-43" tabindex="-1"></a><span class="co">// Any issues?</span></span>
<span id="cb28-44"><a href="#cb28-44" tabindex="-1"></a><span class="kw">func</span> barber2<span class="op">(</span>b <span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span> r <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-45"><a href="#cb28-45" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb28-46"><a href="#cb28-46" tabindex="-1"></a>        <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb28-47"><a href="#cb28-47" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>b<span class="op">:</span></span>
<span id="cb28-48"><a href="#cb28-48" tabindex="-1"></a>            <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb28-49"><a href="#cb28-49" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">&lt;-</span>b<span class="op">:</span></span>
<span id="cb28-50"><a href="#cb28-50" tabindex="-1"></a>                fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;Working on 2 blond hair customers&quot;</span><span class="op">)</span></span>
<span id="cb28-51"><a href="#cb28-51" tabindex="-1"></a>            <span class="cf">default</span><span class="op">:</span></span>
<span id="cb28-52"><a href="#cb28-52" tabindex="-1"></a>                b <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb28-53"><a href="#cb28-53" tabindex="-1"></a>                fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;blond released&quot;</span><span class="op">)</span></span>
<span id="cb28-54"><a href="#cb28-54" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb28-55"><a href="#cb28-55" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>r<span class="op">:</span></span>
<span id="cb28-56"><a href="#cb28-56" tabindex="-1"></a>            <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb28-57"><a href="#cb28-57" tabindex="-1"></a>            <span class="cf">case</span> <span class="op">&lt;-</span>r<span class="op">:</span></span>
<span id="cb28-58"><a href="#cb28-58" tabindex="-1"></a>                <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb28-59"><a href="#cb28-59" tabindex="-1"></a>                <span class="cf">case</span> <span class="op">&lt;-</span>r<span class="op">:</span></span>
<span id="cb28-60"><a href="#cb28-60" tabindex="-1"></a>                    time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">100</span> <span class="op">*</span> time<span class="op">.</span>Millisecond<span class="op">)</span></span>
<span id="cb28-61"><a href="#cb28-61" tabindex="-1"></a>                    fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;Working on 3 red hair customers&quot;</span><span class="op">)</span></span>
<span id="cb28-62"><a href="#cb28-62" tabindex="-1"></a>                <span class="cf">default</span><span class="op">:</span></span>
<span id="cb28-63"><a href="#cb28-63" tabindex="-1"></a>                    r <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb28-64"><a href="#cb28-64" tabindex="-1"></a>                    r <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb28-65"><a href="#cb28-65" tabindex="-1"></a>                    fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;reds released&quot;</span><span class="op">)</span></span>
<span id="cb28-66"><a href="#cb28-66" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb28-67"><a href="#cb28-67" tabindex="-1"></a>            <span class="cf">default</span><span class="op">:</span></span>
<span id="cb28-68"><a href="#cb28-68" tabindex="-1"></a>                r <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb28-69"><a href="#cb28-69" tabindex="-1"></a>                fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;red released&quot;</span><span class="op">)</span></span>
<span id="cb28-70"><a href="#cb28-70" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb28-71"><a href="#cb28-71" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb28-72"><a href="#cb28-72" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-73"><a href="#cb28-73" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb28-74"><a href="#cb28-74" tabindex="-1"></a></span>
<span id="cb28-75"><a href="#cb28-75" tabindex="-1"></a><span class="co">// Customer simulation.</span></span>
<span id="cb28-76"><a href="#cb28-76" tabindex="-1"></a><span class="kw">func</span> customerSimulation<span class="op">(</span>ch <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-77"><a href="#cb28-77" tabindex="-1"></a>    x <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb28-78"><a href="#cb28-78" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb28-79"><a href="#cb28-79" tabindex="-1"></a>        rand<span class="op">.</span>Seed<span class="op">(</span>time<span class="op">.</span>Now<span class="op">().</span>UnixNano<span class="op">())</span></span>
<span id="cb28-80"><a href="#cb28-80" tabindex="-1"></a>        n <span class="op">:=</span> rand<span class="op">.</span>Intn<span class="op">(</span><span class="dv">4</span><span class="op">)</span> <span class="co">// n will be between 0 and 4</span></span>
<span id="cb28-81"><a href="#cb28-81" tabindex="-1"></a>        <span class="co">// fmt.Printf(&quot;Sleeping %d seconds...\n&quot;, n)</span></span>
<span id="cb28-82"><a href="#cb28-82" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span>time<span class="op">.</span>Duration<span class="op">(</span>n<span class="op">)</span> <span class="op">*</span> time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb28-83"><a href="#cb28-83" tabindex="-1"></a>        x<span class="op">++</span></span>
<span id="cb28-84"><a href="#cb28-84" tabindex="-1"></a>        ch <span class="op">&lt;-</span> x</span>
<span id="cb28-85"><a href="#cb28-85" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb28-86"><a href="#cb28-86" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb28-87"><a href="#cb28-87" tabindex="-1"></a></span>
<span id="cb28-88"><a href="#cb28-88" tabindex="-1"></a><span class="kw">func</span> testBarber<span class="op">()</span> <span class="op">{</span></span>
<span id="cb28-89"><a href="#cb28-89" tabindex="-1"></a>    blond <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb28-90"><a href="#cb28-90" tabindex="-1"></a>    red <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb28-91"><a href="#cb28-91" tabindex="-1"></a></span>
<span id="cb28-92"><a href="#cb28-92" tabindex="-1"></a>    <span class="cf">go</span> customerSimulation<span class="op">(</span>blond<span class="op">)</span></span>
<span id="cb28-93"><a href="#cb28-93" tabindex="-1"></a>    <span class="cf">go</span> customerSimulation<span class="op">(</span>red<span class="op">)</span></span>
<span id="cb28-94"><a href="#cb28-94" tabindex="-1"></a></span>
<span id="cb28-95"><a href="#cb28-95" tabindex="-1"></a>    barber<span class="op">(</span>blond<span class="op">,</span> red<span class="op">)</span></span>
<span id="cb28-96"><a href="#cb28-96" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb28-97"><a href="#cb28-97" tabindex="-1"></a></span>
<span id="cb28-98"><a href="#cb28-98" tabindex="-1"></a><span class="kw">func</span> testBarber2<span class="op">()</span> <span class="op">{</span></span>
<span id="cb28-99"><a href="#cb28-99" tabindex="-1"></a>    blond <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb28-100"><a href="#cb28-100" tabindex="-1"></a>    red <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb28-101"><a href="#cb28-101" tabindex="-1"></a></span>
<span id="cb28-102"><a href="#cb28-102" tabindex="-1"></a>    <span class="cf">go</span> customerSimulation<span class="op">(</span>blond<span class="op">)</span></span>
<span id="cb28-103"><a href="#cb28-103" tabindex="-1"></a>    <span class="cf">go</span> customerSimulation<span class="op">(</span>red<span class="op">)</span></span>
<span id="cb28-104"><a href="#cb28-104" tabindex="-1"></a></span>
<span id="cb28-105"><a href="#cb28-105" tabindex="-1"></a>    barber2<span class="op">(</span>blond<span class="op">,</span> red<span class="op">)</span></span>
<span id="cb28-106"><a href="#cb28-106" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div id="exercise-6-dining-philosophers." class="slide section level1">
<h1>Exercise 6: Dining Philosophers.</h1>
<p>We consider the problem of the dining philosophers. The order of
forks doesn’t play a role here. That is, we assume that there are
<code>n</code> philosophers sitting at one table, and there are
<code>n</code> forks. To eat, a philosopher needs two forks.</p>
<h2 id="attempt-1">Attempt 1</h2>
<p>This is a possible implementation.</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="kw">func</span> philo<span class="op">(</span>id <span class="dt">int</span><span class="op">,</span> forks <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>        <span class="op">&lt;-</span>forks</span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>        <span class="op">&lt;-</span>forks</span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;%d eats </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>        forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>        forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span> <span class="co">// think</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>    <span class="kw">var</span> forks <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a>    forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a>    forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a>    forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a>    <span class="cf">go</span> philo<span class="op">(</span><span class="dv">1</span><span class="op">,</span> forks<span class="op">)</span></span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a>    <span class="cf">go</span> philo<span class="op">(</span><span class="dv">2</span><span class="op">,</span> forks<span class="op">)</span></span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a>    philo<span class="op">(</span><span class="dv">3</span><span class="op">,</span> forks<span class="op">)</span></span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We model the forks as buffered channels. Every philosopher needs two
fork. Hence, reading twice from the <code>fork</code> channel.</p>
<p>What kind of problems can we encounter?</p>
<p>Exercise: give concrete examples (as trace).</p>
<h2 id="version-2">Version 2</h2>
<p>Here is another attempt.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a><span class="kw">func</span> philo<span class="op">(</span>id <span class="dt">int</span><span class="op">,</span> forks <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>        <span class="op">&lt;-</span>forks</span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>        <span class="cf">select</span> <span class="op">{</span></span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">&lt;-</span>forks<span class="op">:</span></span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>            fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;%d eats </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>            time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>            forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>            forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>            time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span> <span class="co">// think</span></span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>        <span class="cf">default</span><span class="op">:</span></span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>            forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb30-20"><a href="#cb30-20" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb30-21"><a href="#cb30-21" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb30-23"><a href="#cb30-23" tabindex="-1"></a>    <span class="kw">var</span> forks <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb30-24"><a href="#cb30-24" tabindex="-1"></a>    forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-25"><a href="#cb30-25" tabindex="-1"></a>    forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-26"><a href="#cb30-26" tabindex="-1"></a>    forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb30-27"><a href="#cb30-27" tabindex="-1"></a>    <span class="cf">go</span> philo<span class="op">(</span><span class="dv">1</span><span class="op">,</span> forks<span class="op">)</span></span>
<span id="cb30-28"><a href="#cb30-28" tabindex="-1"></a>    <span class="cf">go</span> philo<span class="op">(</span><span class="dv">2</span><span class="op">,</span> forks<span class="op">)</span></span>
<span id="cb30-29"><a href="#cb30-29" tabindex="-1"></a>    philo<span class="op">(</span><span class="dv">3</span><span class="op">,</span> forks<span class="op">)</span></span>
<span id="cb30-30"><a href="#cb30-30" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="version-3">Version 3</h2>
<p>Consider the following variant.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode go"><code class="sourceCode go"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;time&quot;</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a><span class="kw">func</span> philo<span class="op">(</span>id <span class="dt">int</span><span class="op">,</span> forks <span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>        <span class="op">&lt;-</span>forks</span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>        <span class="op">&lt;-</span>forks</span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>        fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;%d eats </span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>        forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a>        forks <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a>        time<span class="op">.</span>Sleep<span class="op">(</span><span class="dv">1</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span> <span class="co">// think</span></span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb31-20"><a href="#cb31-20" tabindex="-1"></a>    <span class="kw">var</span> forks <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">)</span></span>
<span id="cb31-21"><a href="#cb31-21" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span> forks <span class="op">&lt;-</span> <span class="dv">1</span> <span class="op">}()</span></span>
<span id="cb31-22"><a href="#cb31-22" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span> forks <span class="op">&lt;-</span> <span class="dv">1</span> <span class="op">}()</span></span>
<span id="cb31-23"><a href="#cb31-23" tabindex="-1"></a>    <span class="cf">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span> forks <span class="op">&lt;-</span> <span class="dv">1</span> <span class="op">}()</span></span>
<span id="cb31-24"><a href="#cb31-24" tabindex="-1"></a>    <span class="cf">go</span> philo<span class="op">(</span><span class="dv">1</span><span class="op">,</span> forks<span class="op">)</span></span>
<span id="cb31-25"><a href="#cb31-25" tabindex="-1"></a>    <span class="cf">go</span> philo<span class="op">(</span><span class="dv">2</span><span class="op">,</span> forks<span class="op">)</span></span>
<span id="cb31-26"><a href="#cb31-26" tabindex="-1"></a>    philo<span class="op">(</span><span class="dv">3</span><span class="op">,</span> forks<span class="op">)</span></span>
<span id="cb31-27"><a href="#cb31-27" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Which of the problems you described above can still occur?</p>
</div>
<div id="exercise-7-the-santa-claus-problem"
class="slide section level1">
<h1>Exercise 7: The Santa Claus Problem</h1>
<h2 id="problem-statement">Problem statement</h2>
<p>Santa repeatedly sleeps until wakened by either all of his nine
reindeer, back from their holidays, or by a group of three of his ten
elves. If awakened by the reindeer, he harnesses each of them to his
sleigh, delivers toys with them and finally unharnesses them (allowing
them to go off on holiday). If awakened by a group of elves, he shows
each of the group into his study, consults with them on toy R&amp;D and
finally shows them each out (allowing them to go back to work).</p>
<p>In general, the following priority rule shall be enforced:</p>
<p>Santa gives priority to the reindeer in the case that there is both a
group of elves and a group of reindeer waiting.</p>
</div>
</body>
</html>
